//
// Created by till on 7/19/22.
//

#include <stdio.h>
#include <sys/param.h>
#include <string.h>
#include <bits/time.h>
#include <time.h>
#include "benchmarking.h"
#include "bignum.h"
#include "2x2matrix.h"
#include "testing_constants.h"

// copied from erap week 6 bench
inline double curtime() {
    struct timespec t;
    clock_gettime(CLOCK_MONOTONIC, &t);
    return t.tv_sec + t.tv_nsec * 1e-9;
}

void benchDivision(size_t repetitions) {
    size_t sizes[] = {
            100,
            1000,
            2000,
            3000,
            4000,
            5000,
            10000,
            20000,
            30000,
            40000,
            50000,
            100000,
            200000,
            300000
    };
    char *a[] = {"922163242431207071074983301530248435746125497723607601750",
                 "11991751762490800188596599270386132718575591416042742284803075680437136681298388371933152218501578612216372904986339984104467489751633625975845938448515148872923006348098171963693134992654936446180083405750208055640747879243026459776480994369448351066502291477643628467756309649888313692705973936546310461051145747183757150538811096207717790044468764888752189665664834025124107686212949616378639989085692644313031581789839977094800081481993945664648650187969676855185822591181626739393535479282995118037930935014954804935069783971058492333905905211805373954518024723898871900317031573778231450745273280527366501612697714120469114802869523602710690758149269421406031212263954834465029267056899562302242279976530974459045233048549610843402750997317276283581164754450505141973543962474082954955941425172345329427164050764453670780736020476225774874577037033901630819414851217130285457159133752534241931828394993941818909644680544958766839190691344990328022165979432985173406457723450753892685303151140250654709269918771646319873073170386669247370155754392736601039883734782664692282310707595148756371686286187575533272792215392084514239795560934982602834220702534863134811100073288663086958940432821959713023529030202808467970249023160945245850712228233624078193050063735402332509961840150756048881403735205928530017594746792792688350951227248937700583216724674221670522284353919658227136877505207944450560082101440628283919505317341260849425376577489989071119141415339020762005691657095066364268677538805055399556038478858220935717554879110138422453031696644559405716168456439226467007151106630055335743814558631239407559539136437761476993810942791357386742483059453041366585987109802874241878573207247343236880586208561798083235391144745928110960253226051334816557519106087718329768627894342933733073930797338154426266356958065465758063628773727801604445403887212975805930813802372566332461804539955913947304363832918395466634428432201442076219099351380475828671373173213262035663436750281895125937289172150501318658736107696989339706977269719543602921661630756591162992773437971466248973289729232914104503086548761211788555308595147926791842676738028293258624248818646997028732124914603271256622468427470564917692530685642376983186663456135803345871374686315285665124545291791869033355446846835322152658890062464603842573311870166223711395995267375869690275972935273943558477603481827474187746771954566884356911998386382568328168830652276562406365466773601093200963744006177771046413843144769233101809165132316580541745094686610445943609989834942438755728545596408005764829674751114973941599617118484506435545475874984315922802292749328465206867410308001338680050834405700380671648822364810894199142569008677916047818340516259268042874879036360545697400451746101319105391831477432351544681645198685523245611211164635997650017330421291975966408660846155046114818701890931628196179683264908509703737641036404217817669071918727595658578008081576544521187342906224196863241467800040477243975393986136902875352985951545985292488056840490351084590895478966819463024310277660193874517334352361271871798377738148326502251537959053482908233515281918350115471191661822786797152062158408171109152443050771835403951780297272945030956314931157527681682285199383066281882103276548253379193033163401541321085609122311246845706671789307203361990969048649368064995080040437022031991112267473342124515240068540666801374237469390035543354560398810442917669134744902524591977390852621914190706056127853893674962524476640298390465866782671997084382709215659021526740305805219325150848484248968348079945673711933133979129699733570486902234845362429064067431694375555293727651104518353636740338368132419845276201500444933367937721780833521523658236150219200410819548986950192925567060177774208772568654963820001314066773773866135747965210634105102564625052763429648429619842978459926270901468854544889288204333115129760538913396055076000358196065908706115051147069467321335352971326994328818199042207798668110767131182904605060156071766547553312388327805441629950423981305608307418272657016111296590318367869733390113808468711779345571128832905768998082994987136193375561906133542432826364658247441923389632562480299343761864077537290204467240958851630561343665694211249265910312206336819630242209254276184502247448870507224312704495312332567067022649824937593095829985257423887078717325699504388219227549000548559789869207952070829210703792471816059199141671343892516207565724020667975106131177414166729498209645651255496268470294062227133581252507497495594739434421349815696036335596242016185989124490850469572799160763873791749504080699096465103300924624372590082510514281998248947109466367820574328486478618599214601639537588291554245097892842701885585526211139026277087130427597039635894727403705195797694119164035074023420935323033165218638785834329854946614786361482261842716967717251754586962879403396574645789229120097673867235744603289745769122072111315665885264108788183687210129323486479171876855459267045203159476263757636958191245418718386996258211352308684752976825165017669828766183653327615670041559632729769146573865481864179752290506733470304431302414839416744862640080772834960128638991943952813838552762179630508827427601211133917300821964876956563246466595168675744344427450955158380627834814726768545777482331295376836360674947106161288649163004089197637901696311609109355448933460574909077385065657595524329276520324418245339833731061239490718671860480456104254782571900655406833437291641440067054107451909663218805666053593969025168819192260162199479535835405908519780490364068124155655869403016172121869795998250386477065438478338816688118348819309147694359904354899260874480717806196987120893150415470570511205273544233902084325050566464355318536420211027465045003539789352892427349559524199670248837051788607323157211681988890426831034584081881731728195757337619542610343252128705315549016850478648105289007521766214170090878461166234081213510822929516574767621647206309649043511919270230665089067683283831185023470"};
    char *b[] = {"2226299006599368502957517317696274347946491584213957664249",
                 "28950649741616755924586309573079011811552365311591394211997136734385626121511362468084536514487647535557832620668133246356430172169823239414296214036330538194563234580991370739086262087884298736894869195400215691030235976763478475332883558240105156617543957006944597612234024923907508146971166595824493772977881936095215143732692274017410482419912492317434412579488905313770616360969343870255417318903865226916488794465073884320744196369977336520601923136216617848565806446265165436404119478533241633865797681624084953822291207846323480075420407443379168246889137443398687570928442755966702518410023630076962759088964029566902965433663064174124456301080195879740662494839700731923135472597954604239002358626235517440129949223219558550362520199226852772335039550447934997607054758381387561013143486881066391768062113576851951011711297674456741839110001089108638670363455436268342967698430224733223650498295215155328934635996020255084349149145956624346785174329289504779876892650380164109278685864047248095173312472050184800890332286561732069097604129542998828725232301774022760276994309778314144642320483768177414669377079292602430824201866584456557362584896802624461249486329565890906711060736471711736090764307266819140995103712929943554540536801690804529587024031132647358639142073259312177513959486090477297267825768517735815782022521628776610977080845549080005409090205910948548676439739049827081145908303093429050826277719354336107289815173979225534888988251502999708781547762026653671856998490435083882363395144229598404140810468126789356961207259167022689417339707047221759151711849559010300447823438036065174806493598713289455505708267733435562905140959457826625480407594408778661544097748424787783595101160290287959743205524128633684538631739427128932906906863394909267105204447260553713617364052231517509518394003834145012083115994492186565833647164274760026187644521411223222724172459077604798349661202625587094344736623020818403581303657779619787467426748465067067253849424694928267264626080305658426906485941421176177510295511904518910351517149929801386415310877241764007557994672560516503143638866286205433545605576353098968183910327100408218084699149877626020284534586439256550156192839372295834213270162727492724711038089175869814568755058333445831241774741418266753611998453687013059824113788664782997835851902831647050247008925210222436391847041540788270309439312246615662466361610057874919144848803231471206059260392450286038360543135343138414761278466674901138364052210118697435680498651913454308191282161666563247511743057293049129847164651018175523430089917645394892330078755557132942765006342320650122057008031172145389957646252781807464319427459590643928325682958662079658042190416308208488444135774890297760474838187283357495845008479997361691133180165080497485912426303166654752978392121998766755697907234785059569373346953721974471222029889554654857636347600828162500693106736920447118347390647212125566846797774126583396121972050187149223364744571126512291172087204129241185270150186935042844545757291270832963441408671455428160399588474900528967304343941537466985318142965058117557648027343000584452111855152964732387158748547963127253146752426485729655973296928106909951962486779364483613200958480824899118389705583227550644208138682932522911342267267974577635561404274699059151516594270378991434805037933948083264973458485968195060872767819437331043601898371899098499190785763382520159978176694412318306212651799006562467733494195511278225381971382263134567078748486756870399160690592062771555944431356887799274448325093760379059479438217190884667483697252699825107439449909166805040847464448382531041904613548614554273343155007185584581340119372837623600873732797338155866606965423578382400673277120651141536859432362307461193507676873963039437225507527899486265391290865563620966606862677500646867717968076477147868489394252983227797010410556024426827423598872863924394870219072790026151054036155812705519126549977058127970493106723080643590352706174143888698365132472306395893074343556904199919555258498400740378311476865377333239553623667997539767228303230131605085035100991852891834787877224851479617542834697761683697442764447794866438842858181059001901511634047809293931651246329962124155720443628988465798800263568268918938601608598280286342518945248399912125805377678799637784134213117307236855728205819307718750681384601730929379402540231242252130667668564804405733077991620441719257181203247097488036116634009421082624272073863260063154991973134613725071341301933408932555171581322702769880248761139894710319283788341080785221126688591943670613762916650384392471138791564774150544373855246545209059728321014095052433278334252215468077692839872206317147600757104902742569553483562373802929321823536219911510830183982393917449218130763602925056647111950817183699637428472575403870614649969943303181207941276591693418344777873772770274666588118299623409586639351959619138703804651885648195884362245966000645962876603278632482609914580333769311736804147197851061429100580167463467049434382099848181125995419769257345468207356977202214266085290192756311448294027417463383941005606558300452065872572183356463710240201619151992478956562654873392453970646630826042923796454649515281375406761966612873120535656904131353761683508846341662200084704244647813211738327278687469730956328230312164918239236598054640162856066559850736159996993109250665563183033251697487587362036506307804602816423004687343577338564474206411597207872153991743077831182301649446063587957213838091735057880065964514511592422117168119092357048156781619690581634735353710913595858215535467358799349467769591275061752673723950860890224460702577860471215095313463516765582261497740323652830227849876870096720837286820842018453231430901885970856324586181752467289718483707190209580743515226736175755515092013277836466728769715746252616302282521018966360635401165999959334608785347948579042288662038157891160952481042078814315842601669378468084074173949220014121237817237182183968697385216145781890675623261353138587569"};

    printf("= Benchmarking Division with %zu different accuracies. {100, 1000, 5000, 10000, 20000, 30000, 40000, 50000, 100000, 200000, 300000} =\n",
           sizeof(sizes) / sizeof(size_t));

    for (size_t n = 0; n < sizeof(a) / sizeof(a[0]); n++)
        for (size_t i = 0; i < sizeof(sizes) / sizeof(size_t); ++i) {
            struct bignum b_a = fromHex(a[n]);
            struct bignum b_b = fromHex(b[n]);

            size_t len = strlen(a[n]);
            printf("    Bignum(Size=%zu) / Bignum(Size=%zu); Accuracy=%zu binary places:\n", len, len, sizes[i]);

            printf("        -> Long Division ... ");
            fflush(stdout);

            double longAverage = 0;

            for (size_t j = 0; j < repetitions; ++j) {
                double startTimeLong = curtime();
                struct bignum div_l = longDivision(&b_a, &b_b, sizes[i] / 4);
                double timeLong = curtime() - startTimeLong;

                printf("%.5fs ", timeLong);
                fflush(stdout);
                longAverage += timeLong;
                bignumFree(div_l);
            }
            printf("\n");
            printf("           Average: %.5fs\n", longAverage / repetitions);


            printf("        -> Newton Raphson Division ... ");
            fflush(stdout);

            double newtonAverage = 0;

            for (size_t j = 0; j < repetitions; ++j) {
                double startTimeNewton = curtime();
                struct bignum div_n = newtondiv(&b_a, &b_b, sizes[i]);
                double timeNewton = curtime() - startTimeNewton;

                printf("%.5fs ", timeNewton);
                fflush(stdout);
                newtonAverage += timeNewton;

                bignumFree(div_n);
            }
            printf("\n");
            printf("           Average: %.5fs\n", newtonAverage / repetitions);

            bignumFree(b_a);
            bignumFree(b_b);
        }
}

void benchMatrixExp(size_t repetitions) {
    size_t sizes[] = {1000,
                      10000,
                      20000,
                      30000,
                      40000,
                      50000,
                      60000,
                      70000,
                      80000,
                      90000,
                      100000,
                      200000,
                      300000,
                      400000,
                      500000,
                      600000,
                      700000,
                      800000,
                      900000,
                      1000000,
    };

    printf("= Benchmarking Matrix Exponentiation with 7 different sizes. {1000, 10000, 100000, 500000, 1000000} =\n");

    for (size_t i = 0; i < sizeof(sizes) / sizeof(size_t); ++i) {
        printf("    [[ 0, 1 ], [ 1, 2 ]] ** %zu; binary places:\n", sizes[i]);

        printf("        -> Basic Approach ... ");
        fflush(stdout);

        struct matrix2x2 base = sqrt2Matrix();

        double timeNormalSum = 0;
        for (size_t j = 0; j < repetitions; ++j) {
            double startTimeNormal = curtime();
            struct matrix2x2 matrix = expMatrix(base, sizes[i]);
            double timeNormal = curtime() - startTimeNormal;

            printf("%.5fs ", timeNormal);
            fflush(stdout);

            timeNormalSum += timeNormal;

            freeMatrix(matrix);
        }
        printf("\n");
        printf("           Average: %.5fs\n", timeNormalSum / repetitions);


        printf("        -> Fast Approach ... ");
        fflush(stdout);

        double timeFastSum = 0;
        for (size_t j = 0; j < repetitions; ++j) {
            double startTimeFast = curtime();
            struct matrix2x2 matrix = expMatrixFast(base, sizes[i]);
            double timeFast = curtime() - startTimeFast;

            printf("%.5fs ", timeFast);
            fflush(stdout);

            timeFastSum += timeFast;

            freeMatrix(matrix);
        }
        printf("\n");
        printf("           Average: %.5fs\n", timeFastSum / repetitions);

        freeMatrix(base);
    }
}

void benchMultiplication(size_t repetitions) {
    printf("= Benchmarking Multiplication with 13 different sizes. {2000, 4000, 10000, 50000, 75000, 100000, 250000, 500000, 750000, 1000000} =\n");

    for (size_t i = 0; i < sizeof(multiplication_a) / sizeof(char *); ++i) {
        printf("    Bignum(Size=%zu) * Bignum(Size=%zu);\n", strlen(multiplication_a[i]), strlen(multiplication_b[i]));

        printf("        -> Without Threading ... ");
        fflush(stdout);

        struct bignum bn_a = fromHex((char *) multiplication_a[i]);
        struct bignum bn_b = fromHex((char *) multiplication_b[i]);

        double timeWithoutThreadingSum = 0;
        for (size_t j = 0; j < repetitions; ++j) {
            double startTimeWithoutThreading = curtime();
            struct bignum result = _multiplication(bn_a, bn_b, false);
            double timeWithoutThreading = curtime() - startTimeWithoutThreading;

            printf("%.5fs ", timeWithoutThreading);
            fflush(stdout);

            timeWithoutThreadingSum += timeWithoutThreading;

            bignumFree(result);
        }
        printf("\n");
        printf("           Average: %.5fs\n", timeWithoutThreadingSum / repetitions);


        printf("        -> With Threading ... ");
        fflush(stdout);

        double timeWithThreadingSum = 0;
        for (size_t j = 0; j < repetitions; ++j) {
            double startTimeWithThreading = curtime();
            struct bignum result = multiplication(bn_a, bn_b);
            double timeWithThreading = curtime() - startTimeWithThreading;

            printf("%.5fs ", timeWithThreading);
            fflush(stdout);

            timeWithThreadingSum += timeWithThreading;

            bignumFree(result);
        }
        printf("\n");
        printf("           Average: %.5fs\n", timeWithThreadingSum / repetitions);

        bignumFree(bn_a);
        bignumFree(bn_b);
    }
}